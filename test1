@startuml
title Funding Return Save - End to End Flow

' LAYOUT HINTS
left to right direction

'=== UI LAYER ===
package "UI" {
  [Return UI Save\n(user clicks Save)] as BtnSave
}

'=== API LAYER ===
package ".NET Core API" {
  [Controller\n(receives HTTP request)] as Ctrl
  [TransactionOrchestrator\n(coordinates save + queue)] as TxnOrch
  [ApplyChanges\n(update EF entities from DTO)] as Apply
  [AuditCaptureService\n(build AuditContext from ChangeTracker)] as AuditCap
  [HandlerChainResolver\n(derive handler list)] as HandlerRes
  [WorkItemFactory\n(build WorkItemPayload)] as PayloadBuild
  [WorkItemQueueWriter\n(insert row into WORK_ITEM_QUEUE)] as QueueWrite
}

'=== BUSINESS DB ===
database "Business DB" {
  [Loan / Funding Tables] as BizTables
}

'=== QUEUE DB ===
database "Queue DB" {
  [WORK_ITEM_QUEUE\n(outbox of pending work items)] as WQ
}

'=== WORKER SERVICE ===
package "Worker Service" {
  [Poller\n(fetch pending work items)] as Poll
  [WorkItemProcessor\n(process one work item)] as ProcItem
  [ContextBuilder\n(deserialize payload + build context)] as CtxBuild
}

'=== HANDLERS (ORCHESTRATORS) ===
package "Handlers (Orchestrators)" {
  [Generic_Save_Handler\n(global behavior)] as HGen
  [FundingModule_Return_Handler\n(screen-level logic)] as HFundReturn
  [FundingModule_Return_Save_Handler\n(operation-level logic)] as HFundReturnSave
}

'=== PROCESSORS (REUSABLE UNITS) ===
package "Processors" {
  [AuditTrailProcessor\n(filter changes + call legacy audit)] as PAudit
  [EventCreatorProcessor\n(select and publish events)] as PEvent
  [StatusUpdateProcessor\n(update loan/status)] as PStatus
  [ServiceCallProcessor\n(call external REST/services)] as PService
}

'=== EXTERNAL / LEGACY SYSTEMS ===
package "External / Legacy Systems" {
  [Legacy Audit Engine\n(C++ wrapper)] as LegacyAudit
  [Event Bus / Kafka Topic] as EventBus
  [Status / Core System] as StatusSys
  [External REST Systems] as RestSvc
}

'=== FLOW: UI -> API ===
BtnSave --> Ctrl
Ctrl --> TxnOrch

TxnOrch --> Apply
Apply --> BizTables

TxnOrch --> AuditCap
AuditCap --> HandlerRes
HandlerRes --> PayloadBuild
PayloadBuild --> QueueWrite
QueueWrite --> WQ

'=== FLOW: QUEUE -> WORKER ===
WQ --> Poll
Poll --> ProcItem
ProcItem --> CtxBuild

'=== HANDLER CHAIN FOR FUNDING RETURN SAVE ===
CtxBuild --> HGen
CtxBuild --> HFundReturn
CtxBuild --> HFundReturnSave

'=== EACH HANDLER ORCHESTRATES PROCESSORS ===
HGen --> PAudit
HGen --> PEvent

HFundReturn --> PAudit
HFundReturn --> PEvent

HFundReturnSave --> PAudit
HFundReturnSave --> PEvent
HFundReturnSave --> PStatus
HFundReturnSave --> PService

'=== PROCESSORS -> EXTERNAL SYSTEMS ===
PAudit --> LegacyAudit
PEvent --> EventBus
PStatus --> StatusSys
PService --> RestSvc

@enduml
