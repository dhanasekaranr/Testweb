flowchart LR

    %% UI
    subgraph UI
        BtnSave[Return UI Save - user clicks button]
    end

    %% API LAYER
    subgraph API
        Ctrl[Controller - receives HTTP request]
        TxnOrch[TransactionOrchestrator - coordinates save and queue]
        Apply[ApplyChanges - update EF entities from DTO]
        AuditCap[AuditCaptureService - build AuditContext from EF ChangeTracker]
        HandlerRes[HandlerChainResolver - compute handler list for module screen operation]
        PayloadBuild[WorkItemFactory - build WorkItemPayload object]
        QueueWrite[WorkItemQueueWriter - insert row into WORK_ITEM_QUEUE]
    end

    %% BUSINESS DB
    subgraph BusinessDB
        BizTables[Business tables - Loan Funding etc]
    end

    %% QUEUE DB
    subgraph QueueDB
        WQ[WORK_ITEM_QUEUE - outbox of pending work items]
    end

    %% WORKER SERVICE
    subgraph Worker
        Poll[Poller - fetch batch of pending work items]
        ProcItem[WorkItemProcessor - process one work item at a time]
        CtxBuild[ContextBuilder - deserialize payload and build processor context]
    end

    %% HANDLERS (ORCHESTRATORS)
    subgraph Handlers
        HGen[Generic_Save_Handler - global behavior for many screens]
        HFundReturn[FundingModule_Return_Handler - funding return screen level logic]
        HFundReturnSave[FundingModule_Return_Save_Handler - operation specific save logic]
    end

    %% PROCESSORS (REUSABLE UNITS)
    subgraph Processors
        PAudit[AuditTrailProcessor - filter changes and call legacy audit]
        PEvent[EventCreatorProcessor - select and publish events]
        PStatus[StatusUpdateProcessor - update loan or other status]
        PService[ServiceCallProcessor - call external REST or services]
    end

    %% EXTERNAL AND LEGACY SYSTEMS
    subgraph External
        LegacyAudit[Legacy audit engine - C plus plus wrapper]
        EventBus[Event bus or Kafka topic]
        StatusSys[Status or core system]
        RestSvc[External REST systems or services]
    end

    %% UI -> API FLOW
    BtnSave --> Ctrl
    Ctrl --> TxnOrch

    TxnOrch --> Apply
    Apply --> BizTables

    TxnOrch --> AuditCap
    AuditCap --> HandlerRes
    HandlerRes --> PayloadBuild
    PayloadBuild --> QueueWrite
    QueueWrite --> WQ

    %% QUEUE -> WORKER FLOW
    WQ --> Poll
    Poll --> ProcItem
    ProcItem --> CtxBuild

    %% HANDLER CHAIN FOR FUNDING RETURN SAVE
    CtxBuild --> HGen
    CtxBuild --> HFundReturn
    CtxBuild --> HFundReturnSave

    %% EACH HANDLER ORCHESTRATES PROCESSORS
    HGen --> PAudit
    HGen --> PEvent

    HFundReturn --> PAudit
    HFundReturn --> PEvent

    HFundReturnSave --> PAudit
    HFundReturnSave --> PEvent
    HFundReturnSave --> PStatus
    HFundReturnSave --> PService

    %% PROCESSORS -> EXTERNAL SYSTEMS
    PAudit --> LegacyAudit
    PEvent --> EventBus
    PStatus --> StatusSys
    PService --> RestSvc
