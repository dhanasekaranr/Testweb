// ====================================================================
// Complete End-to-End Lookup Implementation
// ====================================================================

// --------------------------------------------------------------------
// File: libs/core/lookup/lookup.tokens.ts
// --------------------------------------------------------------------
import { InjectionToken } from '@angular/core';

/** API URL for lookup service */
export const LOOKUP_API_URL = new InjectionToken<string>('LookupApiUrl', {
  providedIn: 'root',
  factory: () => '/commonapi/lookup'
});

// --------------------------------------------------------------------
// File: libs/core/lookup/lookup.service.ts
// --------------------------------------------------------------------
import { Injectable, Inject } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { Observable } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { LookupItem } from './state/lookup.models';
import { LOOKUP_API_URL } from './lookup.tokens';

@Injectable({ providedIn: 'root' })
export class LookupService {
  private cache = new Map<string, Observable<LookupItem[]>>();

  constructor(
    private http: HttpClient,
    @Inject(LOOKUP_API_URL) private apiUrl: string
  ) {}

  /**
   * Fetch lookup items by name and optional parameters.
   * Caches per name+params key.
   */
  get(name: string, uiParams?: Record<string, any>): Observable<LookupItem[]> {
    const key = `${name}|${JSON.stringify(uiParams || {})}`;
    if (!this.cache.has(key)) {
      let params = new HttpParams().set('names', name);
      if (uiParams) {
        Object.entries(uiParams).forEach(([k, v]) => {
          if (v != null) {
            params = params.set(k, v);
          }
        });
      }
      const request$ = this.http
        .get<Record<string, LookupItem[]>>(this.apiUrl, { params })
        .pipe(
          map(res => res[name] || []),
          shareReplay(1)
        );
      this.cache.set(key, request$);
    }
    return this.cache.get(key)!;
  }
}

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.models.ts
// --------------------------------------------------------------------
export interface LookupItem {
  /** The actual value to bind */
  value: string | number;
  /** Display name */
  name: string;
  /** Any additional JSON data */
  additionaldata?: Record<string, any>;
  [key: string]: any;
}

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.actions.ts
// --------------------------------------------------------------------
import { createAction, props } from '@ngrx/store';
import { LookupItem } from './lookup.models';

export const loadLookup = createAction(
  '[Lookup] Load',
  props<{ name: string; uiParams?: Record<string, any> }>()
);
export const loadLookupSuccess = createAction(
  '[Lookup] Load Success',
  props<{ name: string; items: LookupItem[]; uiParamsKey: string }>()
);
export const loadLookupFailure = createAction(
  '[Lookup] Load Failure',
  props<{ name: string; error: any }>()
);

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.reducer.ts
// --------------------------------------------------------------------
import { createReducer, on } from '@ngrx/store';
import * as LookupActions from './lookup.actions';
import { LookupItem } from './lookup.models';

export const lookupFeatureKey = 'lookup';

export interface LookupState {
  entities: Record<string, Record<string, LookupItem[]>>;
  loading: boolean;
  error: any;
}

export const initialLookupState: LookupState = {
  entities: {},
  loading: false,
  error: null
};

export const lookupReducer = createReducer(
  initialLookupState,
  on(LookupActions.loadLookup, state => ({ ...state, loading: true, error: null })),
  on(LookupActions.loadLookupSuccess, (state, { name, items, uiParamsKey }) => ({
    ...state,
    loading: false,
    entities: {
      ...state.entities,
      [name]: {
        ...state.entities[name],
        [uiParamsKey]: items
      }
    }
  })),
  on(LookupActions.loadLookupFailure, (state, { error }) => ({ ...state, loading: false, error }))
);

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.selectors.ts
// --------------------------------------------------------------------
import { createFeatureSelector, createSelector } from '@ngrx/store';
import { lookupFeatureKey, LookupState } from './lookup.reducer';
import { serializeParams } from './lookup.utils';

const selectLookupFeature = createFeatureSelector<LookupState>(lookupFeatureKey);

export const selectLookupItems = (
  name: string,
  uiParams?: Record<string, any>
) =>
  createSelector(
    selectLookupFeature,
    state => state.entities[name]?.[serializeParams(uiParams)] ?? []
  );

export const selectLookupLoading = createSelector(
  selectLookupFeature,
  state => state.loading
);

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.effects.ts
// --------------------------------------------------------------------
import { Injectable } from '@angular/core';
import { Actions, createEffect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { catchError, map, mergeMap } from 'rxjs/operators';
import * as LookupActions from './lookup.actions';
import { LookupService } from '../lookup.service';
import { serializeParams } from './lookup.utils';

@Injectable()
export class LookupEffects {
  loadLookup$ = createEffect(() =>
    this.actions$.pipe(
      ofType(LookupActions.loadLookup),
      mergeMap(({ name, uiParams }) =>
        this.lookupService.get(name, uiParams).pipe(
          map(items =>
            LookupActions.loadLookupSuccess({
              name,
              items,
              uiParamsKey: serializeParams(uiParams)
            })
          ),
          catchError(error => of(LookupActions.loadLookupFailure({ name, error })))
        )
      )
    )
  );

  constructor(
    private actions$: Actions,
    private lookupService: LookupService
  ) {}
}

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.utils.ts
// --------------------------------------------------------------------
export function serializeParams(params?: Record<string, any>): string {
  if (!params) return '';
  return Object.keys(params)
    .sort()
    .map(k => `${k}=${JSON.stringify(params[k])}`)
    .join('&');
}

// --------------------------------------------------------------------
// File: libs/core/lookup/state/lookup.state.ts
// --------------------------------------------------------------------
import { NgModule } from '@angular/core';
import { StoreModule } from '@ngrx/store';
import { EffectsModule } from '@ngrx/effects';
import { lookupFeatureKey, lookupReducer } from './lookup.reducer';
import { LookupEffects } from './lookup.effects';

@NgModule({
  imports: [
    StoreModule.forFeature(lookupFeatureKey, lookupReducer),
    EffectsModule.forFeature([LookupEffects])
  ]
})
export class LookupStateModule {}

// --------------------------------------------------------------------
// File: libs/core/src/lib/core.module.ts
// --------------------------------------------------------------------
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LookupStateModule } from '../lookup/state/lookup.state';

@NgModule({
  imports: [
    CommonModule,
    LookupStateModule
  ]
})
export class CoreModule {}

// --------------------------------------------------------------------
// File: libs/shared/lookup/lookup-select.component.ts
// --------------------------------------------------------------------
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { LookupItem } from '@yourorg/core/lookup/state/lookup.models';

@Component({
  selector: 'app-lookup-select',
  template: `
    <mat-form-field appearance="fill">
      <mat-label>{{ placeholder }}</mat-label>
      <mat-select
        [value]="selected"
        (openedChange)="onOpen()"
        (selectionChange)="onChange($event.value)"
        [multiple]="multiple"
      >
        <mat-option *ngFor="let item of items" [value]="item.value">{{ item.name }}</mat-option>
      </mat-select>
    </mat-form-field>
  `
})
export class LookupSelectComponent {
  @Input() items: LookupItem[] = [];
  @Input() placeholder = 'Select';
  @Input() multiple = false;
  @Input() selected: string | number | Array<string | number> | null = null;
  @Output() selectedChange = new EventEmitter<string | number | Array<string | number>>();
  @Output() openedChange = new EventEmitter<boolean>();

  onOpen(): void {
    this.openedChange.emit(true);
  }

  onChange(value: any): void {
    this.selectedChange.emit(value);
  }
}

// --------------------------------------------------------------------
// Usage in Funding feature

// File: libs/funding/src/lib/components/fund-selector.component.ts
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { Store } from '@ngrx/store';
import { loadLookup } from '@yourorg/core/lookup/state/lookup.actions';
import { selectLookupItems } from '@yourorg/core/lookup/state/lookup.selectors';
import { Observable } from 'rxjs';
import { LookupItem } from '@yourorg/core/lookup/state/lookup.models';

@Component({
  selector: 'app-fund-selector',
  template: `
    <app-lookup-select
      [items]="funds$ | async"
      placeholder="{{ placeholder }}"
      (openedChange)="onOpen()"
      (selectedChange)="selectedChange.emit($event)"
    ></app-lookup-select>
  `
})
export class FundSelectorComponent {
  @Input() placeholder = 'Select Fund';
  @Output() selectedChange = new EventEmitter<string | number>();
  funds$!: Observable<LookupItem[]>;

  constructor(private store: Store) {}

  onOpen(): void {
    this.store.dispatch(loadLookup({ name: 'funds' }));
    this.funds$ = this.store.select(selectLookupItems('funds'));
  }
}

// File: libs/funding/src/lib/funding.module.ts
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { MatSelectModule } from '@angular/material/select';
import { LookupSelectComponent } from '@yourorg/shared/lookup/lookup-select.component';
import { FundSelectorComponent } from './components/fund-selector.component';

@NgModule({
  declarations: [FundSelectorComponent],
  imports: [CommonModule, MatSelectModule],
  exports: [FundSelectorComponent]
})
export class FundingModule {}
