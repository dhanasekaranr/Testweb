import { BookingScreen } from '../../../support/screens/booking.screen';
import type { BookingPageDto } from '../../../support/data/booking.factory';

describe('Booking - behavior', () => {
  it('Scenario 1: loadBooking binds initial dto', () => {
    BookingScreen.stubLoad({ fixture: 'funding/booking/loadbooking.json' });

    BookingScreen.visit();
    BookingScreen.waitLoad();

    // quick proof binding happened
    BookingScreen.els.amount().should('have.value', '1000');
  });

  it('Scenario 2: change status + saveBooking (single save endpoint)', () => {
    BookingScreen.stubLoad({ fixture: 'funding/booking/loadbooking.json' });

    cy.fixture('funding/booking/loadbooking.json').then((loaded: BookingPageDto) => {
      const expected: BookingPageDto = { ...loaded, status: 'Approved' };

      BookingScreen.stubSave((req) => {
        // If backend posts full BookingPageDto:
        expect(req.body).to.deep.include(expected);

        // response = same dto
        req.reply({ statusCode: 200, body: expected });
      });

      BookingScreen.visit();
      BookingScreen.waitLoad();

      BookingScreen.changeStatus('Approved');
      BookingScreen.save();

      BookingScreen.waitSave();
      BookingScreen.els.toastSuccess().should('be.visible');
    });
  });

  it('Scenario 3: change billingInfo + alsAccountCode + saveBooking', () => {
    BookingScreen.stubLoad({ fixture: 'funding/booking/loadbooking.json' });

    cy.fixture('funding/booking/loadbooking.json').then((loaded: BookingPageDto) => {
      const expected: BookingPageDto = {
        ...loaded,
        billingInfo: 'BillToCustomer',
        alsAccountCode: 'ALS999'
      };

      BookingScreen.stubSave((req) => {
        expect(req.body).to.deep.include(expected);
        req.reply({ statusCode: 200, body: expected });
      });

      BookingScreen.visit();
      BookingScreen.waitLoad();

      BookingScreen.changeBillingInfo('BillToCustomer');
      BookingScreen.changeAlsAccountCode('ALS999');
      BookingScreen.save();

      BookingScreen.waitSave();
      BookingScreen.els.toastSuccess().should('be.visible');
    });
  });
});
