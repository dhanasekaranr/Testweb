/**
 * Angular Material helpers (mat-select / mat-option).
 *
 * Assumptions:
 * - Your shared leaf component stamps data-cy on the actual <mat-select>:
 *     <mat-select [attr.data-cy]="dataCy"> ... </mat-select>
 *
 * If data-cy is on a wrapper element instead, this helper still tries to find
 * the nested <mat-select> or the combobox trigger.
 */

type OpenTarget =
  | { cy: string }
  | { selector: string };

function getTargetEl(target: OpenTarget): Cypress.Chainable<JQuery<HTMLElement>> {
  if ('cy' in target) return cy.get(`[data-cy="${target.cy}"]`);
  return cy.get(target.selector);
}

function clickMatSelectTarget($el: JQuery<HTMLElement>) {
  // Case 1: data-cy is on <mat-select> itself
  if ($el.is('mat-select')) {
    cy.wrap($el).click();
    return;
  }

  // Case 2: data-cy is on wrapper -> find inner mat-select
  const inner = $el.find('mat-select');
  if (inner.length) {
    cy.wrap(inner).click();
    return;
  }

  // Case 3: fallback -> click combobox trigger (Material uses role="combobox")
  const combo = $el.find('[role="combobox"]').first();
  if (combo.length) {
    cy.wrap(combo).click({ force: true });
    return;
  }

  throw new Error(
    `Unable to open mat-select for target. Put data-cy on <mat-select> or ensure wrapper contains mat-select/combobox trigger.`
  );
}

/**
 * Opens the mat-select panel for a given data-cy (or selector).
 */
export function openMatSelect(targetCy: string) {
  getTargetEl({ cy: targetCy }).then(($el) => clickMatSelectTarget($el));
  // Wait for overlay panel to show up (mat-option list lives in the overlay container)
  cy.get('.cdk-overlay-container .cdk-overlay-pane', { timeout: 10_000 })
    .should('be.visible');
}

/**
 * Selects a mat-option by visible text.
 * - Works with overlay-based options (Material renders options under .cdk-overlay-container)
 * - Guards against selecting disabled options
 */
export function selectMatOption(targetCy: string, optionText: string) {
  openMatSelect(targetCy);

  // Options live in overlay; match by text.
  // Use contains() to be a little resilient (spacing, etc.)
  cy.get('.cdk-overlay-container mat-option', { timeout: 10_000 })
    .contains(optionText)
    .should(($opt) => {
      const cls = $opt.attr('class') ?? '';
      const disabled =
        cls.includes('mat-mdc-option-disabled') ||
        cls.includes('mat-option-disabled') ||
        $opt.attr('aria-disabled') === 'true';
      expect(disabled, `Option "${optionText}" should not be disabled`).to.eq(false);
    })
    .click();

  // Panel should close after selection
  cy.get('.cdk-overlay-container .cdk-overlay-pane').should('not.exist');
}

/**
 * Assert the selected value text shown in the mat-select trigger.
 * (Material renders selected text inside the select trigger)
 */
export function assertMatSelectValue(targetCy: string, expectedText: string) {
  // This works well with MDC mat-select:
  // <mat-select ...> <div class="mat-mdc-select-value"> ... </div>
  cy.get(`[data-cy="${targetCy}"]`)
    .should('be.visible')
    .within(() => {
      cy.get('.mat-mdc-select-value-text, .mat-select-value-text', { timeout: 5_000 })
        .should('contain.text', expectedText);
    });
}
