// cypress/support/app/material.ts
const escapeRegExp = (s: string) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

export function matSelectChangeByText(selectCy: string, optionText: string) {
  // Works whether data-cy is on mat-select OR on a wrapping element (mat-form-field/div)
  cy.get(`[data-cy="${selectCy}"]`, { timeout: 10_000 })
    .should('be.visible')
    .then(($root) => {
      const $matSelect = $root.is('mat-select') ? $root : $root.find('mat-select').first();
      expect($matSelect.length, `mat-select found under data-cy="${selectCy}"`).to.be.greaterThan(0);
      cy.wrap($matSelect).click({ force: true });
    });

  // Options render in the overlay container (outside the component DOM)
  cy.get('mat-option', { timeout: 20_000 })
    .contains(new RegExp(`^\\s*${escapeRegExp(optionText)}\\s*$`))
    .scrollIntoView()
    .click({ force: true });

  // Close overlay / commit selection (some apps need this)
  cy.get('body').click(0, 0);
}

export function assertMatSelectValueText(selectCy: string, expectedText: string) {
  cy.get(`[data-cy="${selectCy}"]`, { timeout: 10_000 })
    .should('be.visible')
    .then(($root) => {
      const $matSelect = $root.is('mat-select') ? $root : $root.find('mat-select').first();
      cy.wrap($matSelect)
        .find('.mat-mdc-select-min-line, .mat-mdc-select-value-text, .mat-select-value-text')
        .should('contain.text', expectedText);
    });
}
