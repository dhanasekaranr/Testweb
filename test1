#!/usr/bin/env node
/**
 * Build libraries using TypeScript compiler (bypasses ng-packagr Node 22 issues)
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';

const libs = ['core', 'shared', 'feature'];

function buildLibrary(libName) {
  console.log(`Building ${libName}...`);
  
  const projectPath = path.join(process.cwd(), 'projects', libName);
  const distPath = path.join(process.cwd(), 'dist', libName);
  
  // Create dist folder
  if (!fs.existsSync(distPath)) {
    fs.mkdirSync(distPath, { recursive: true });
  }
  
  // Compile TypeScript directly to dist
  try {
    execSync('npx tsc -p tsconfig.lib.json --skipLibCheck', {
      cwd: projectPath,
      stdio: 'pipe'
    });
  } catch (error) {
    console.log(`⚠ ${libName} compiled with warnings`);
  }
  
  // Copy package.json
  fs.copyFileSync(
    path.join(projectPath, 'package.json'),
    path.join(distPath, 'package.json')
  );
  
  // Copy README if exists
  const readmePath = path.join(projectPath, 'README.md');
  if (fs.existsSync(readmePath)) {
    fs.copyFileSync(readmePath, path.join(distPath, 'README.md'));
  }
  
  console.log(`✓ ${libName} built successfully`);
}

// Clean dist folders
const distPath = path.join(process.cwd(), 'dist');
if (fs.existsSync(distPath)) {
  libs.forEach(lib => {
    const libPath = path.join(distPath, lib);
    if (fs.existsSync(libPath)) {
      fs.rmSync(libPath, { recursive: true, force: true });
    }
  });
}

// Build all libraries
console.log('Building libraries...\n');
libs.forEach(buildLibrary);
console.log('\n✓ All libraries built successfully');
