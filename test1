## Project Structure

```
/src
  /Shared.LookupService
    Shared.LookupService.csproj
    /Models
      LookupDefinition.cs
      LookupItem.cs
    /Data
      MockDbContext.cs
      LookupDefinitionEntity.cs
      LoanStatusCategoryEntity.cs
      LoanStatusEntity.cs
    /Stores
      ILookupDefinitionStore.cs
      DbLookupDefinitionStore.cs
      JsonLookupDefinitionStore.cs
    /Providers
      ILookupProvider.cs
      TableLookupProvider.cs
      HandlerLookupProvider.cs
      ProductTypeLookupHandler.cs
    /Factory
      LookupProviderFactory.cs
    /Services
      ILookupDataService.cs
      LookupDataService.cs
      CachingLookupDataService.cs
    /Extensions
      ServiceCollectionExtensions.cs

  /LookupApi.Common
    LookupApi.Common.csproj
    Program.cs
    appsettings.json
    /Controllers
      LookupController.cs

  /FundingModuleApi
    FundingModuleApi.csproj
    Program.cs
    appsettings.json
    /Controllers
      FundingController.cs
```

---

# Shared.LookupService (Class Library)

### Shared.LookupService.csproj

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" Version="8.0.0" />
    <PackageReference Include="Dapper" Version="2.0.123" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="8.0.0" />
  </ItemGroup>
</Project>
```

### Models/LookupDefinition.cs

```csharp
namespace Shared.LookupService.Models;

/// <summary>
/// Defines a lookup and its source configuration.
/// Only one source property should be set based on <see cref="LookupSourceType"/>.
/// </summary>
public class LookupDefinition
{
    public string Key { get; set; } = null!;
    public LookupSourceType SourceType { get; set; }
    public string? TableName { get; set; }
    public string? Sql { get; set; }
    public string? EntityType { get; set; }
    public string? HandlerType { get; set; }
    public string[] FilterColumns { get; set; } = Array.Empty<string>();
    public string? SortBy { get; set; }
    public string? CodeColumn { get; set; }
    public string? DescColumn { get; set; }
    public string[] AdditionalColumns { get; set; } = Array.Empty<string>();
}

public enum LookupSourceType
{
    Table,
    Sql,
    Entity,
    Handler
}
```

### Models/LookupItem.cs

```csharp
namespace Shared.LookupService.Models;

public record LookupItem(
    string Code,
    string Description,
    IDictionary<string, object>? AdditionalData = null
);
```

---

## Data (Entities & DbContext)

### Data/LookupDefinitionEntity.cs

```csharp
namespace Shared.LookupService.Data;

public class LookupDefinitionEntity
{
    public string Key { get; set; } = null!;
    public string? TableName { get; set; }
    public string? Sql { get; set; }
    public string? EntityType { get; set; }
    public string? HandlerType { get; set; }
    public string FilterColumns { get; set; } = "[]";
    public string? SortBy { get; set; }
    public string? CodeColumn { get; set; }
    public string? DescColumn { get; set; }
    public string AdditionalColumns { get; set; } = "[]";
}
```

### Data/LoanStatusCategoryEntity.cs

```csharp
namespace Shared.LookupService.Data;

public class LoanStatusCategoryEntity
{
    public int Id { get; set; }
    public string Name { get; set; } = null!;
    public ICollection<LoanStatusEntity> LoanStatuses { get; set; } = new List<LoanStatusEntity>();
}
```

### Data/LoanStatusEntity.cs

```csharp
namespace Shared.LookupService.Data;

public class LoanStatusEntity
{
    public int Id { get; set; }
    public string Description { get; set; } = null!;
    public int LoanStatusCategoryId { get; set; }
    public LoanStatusCategoryEntity Category { get; set; } = null!;
}
```

### Data/MockDbContext.cs

```csharp
using Microsoft.EntityFrameworkCore;
using System.Text.Json;

namespace Shared.LookupService.Data;

public class MockDbContext : DbContext
{
    public MockDbContext(DbContextOptions<MockDbContext> options)
        : base(options)
    {
    }

    public DbSet<LookupDefinitionEntity> LookupDefinitions { get; set; }
    public DbSet<LoanStatusCategoryEntity> LoanStatusCategories { get; set; }
    public DbSet<LoanStatusEntity> LoanStatuses { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // LookupDefinitions
        modelBuilder.Entity<LookupDefinitionEntity>(entity =>
        {
            entity.HasKey(e => e.Key);
            entity.Property(e => e.Key).HasMaxLength(100).IsRequired();
            entity.Property(e => e.TableName).HasMaxLength(100);
            entity.Property(e => e.Sql);
            entity.Property(e => e.EntityType).HasMaxLength(200);
            entity.Property(e => e.HandlerType).HasMaxLength(200);
            entity.Property(e => e.FilterColumns);
            entity.Property(e => e.SortBy).HasMaxLength(100);
            entity.Property(e => e.CodeColumn).HasMaxLength(100);
            entity.Property(e => e.DescColumn).HasMaxLength(100);
            entity.Property(e => e.AdditionalColumns);

            entity.HasData(
                new LookupDefinitionEntity {
                    Key = "Countries",
                    TableName = "RefCountries",
                    FilterColumns = JsonSerializer.Serialize(new[] { "IsActive" }),
                    SortBy = "CountryName",
                    CodeColumn = "CountryCode",
                    DescColumn = "CountryName",
                    AdditionalColumns = JsonSerializer.Serialize(Array.Empty<string>())
                },
                new LookupDefinitionEntity {
                    Key = "LoanStatusCategory",
                    TableName = "LoanStatusCategories",
                    SortBy = "Name",
                    CodeColumn = "Id",
                    DescColumn = "Name",
                    AdditionalColumns = JsonSerializer.Serialize(Array.Empty<string>())
                },
                new LookupDefinitionEntity {
                    Key = "LoanStatuses",
                    TableName = "LoanStatuses",
                    FilterColumns = JsonSerializer.Serialize(new[] { "LoanStatusCategoryId" }),
                    SortBy = "Description",
                    CodeColumn = "Id",
                    DescColumn = "Description",
                    AdditionalColumns = JsonSerializer.Serialize(Array.Empty<string>())
                }
            );
        });

        // LoanStatusCategory
        modelBuilder.Entity<LoanStatusCategoryEntity>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Name).HasMaxLength(100).IsRequired();
            entity.HasData(
                new LoanStatusCategoryEntity { Id = 1, Name = "Application" },
                new LoanStatusCategoryEntity { Id = 2, Name = "Approval" }
            );
        });

        // LoanStatus
        modelBuilder.Entity<LoanStatusEntity>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Description).HasMaxLength(200).IsRequired();
            entity.HasOne(e => e.Category)
                  .WithMany(c => c.LoanStatuses)
                  .HasForeignKey(e => e.LoanStatusCategoryId);
            entity.HasData(
                new LoanStatusEntity { Id = 1, Description = "Submitted", LoanStatusCategoryId = 1 },
                new LoanStatusEntity { Id = 2, Description = "In Review", LoanStatusCategoryId = 1 },
                new LoanStatusEntity { Id = 3, Description = "Approved", LoanStatusCategoryId = 2 },
                new LoanStatusEntity { Id = 4, Description = "Funded", LoanStatusCategoryId = 2 }
            );
        });
    }
}
```

---

## Stores

### Stores/ILookupDefinitionStore.cs

```csharp
using Shared.LookupService.Models;

namespace Shared.LookupService.Stores;

public interface ILookupDefinitionStore
{
    Task<IReadOnlyList<LookupDefinition>> GetAllAsync();
    Task RefreshAsync(string key);
    Task RefreshAllAsync();
}
```

### Stores/DbLookupDefinitionStore.cs

```csharp
using System.Text.Json;
using Microsoft.EntityFrameworkCore;
using Shared.LookupService.Models;
using Shared.LookupService.Data;

namespace Shared.LookupService.Stores;

public class DbLookupDefinitionStore : ILookupDefinitionStore
{
    private readonly MockDbContext _db;
    public DbLookupDefinitionStore(MockDbContext db) => _db = db;

    public async Task<IReadOnlyList<LookupDefinition>> GetAllAsync()
    {
        var rows = await _db.LookupDefinitions.AsNoTracking().ToListAsync();
        return rows.Select(r => new LookupDefinition {
            Key               = r.Key,
            SourceType        = LookupSourceType.Table,
            TableName         = r.TableName,
            Sql               = r.Sql,
            EntityType        = r.EntityType,
            HandlerType       = r.HandlerType,
            FilterColumns     = JsonSerializer.Deserialize<string[]>(r.FilterColumns) ?? Array.Empty<string>(),
            SortBy            = r.SortBy,
            CodeColumn        = r.CodeColumn,
            DescColumn        = r.DescColumn,
            AdditionalColumns = JsonSerializer.Deserialize<string[]>(r.AdditionalColumns) ?? Array.Empty<string>()
        }).ToList();
    }

    public Task RefreshAsync(string key) => Task.CompletedTask;
    public Task RefreshAllAsync() => Task.CompletedTask;
}
```

### Stores/JsonLookupDefinitionStore.cs

```csharp
using Microsoft.Extensions.Options;
using Shared.LookupService.Models;

namespace Shared.LookupService.Stores;

public class JsonLookupDefinitionStore : ILookupDefinitionStore
{
    private readonly IOptionsMonitor<List<LookupDefinition>> _monitor;
    public JsonLookupDefinitionStore(IOptionsMonitor<List<LookupDefinition>> monitor)
        => _monitor = monitor;

    public Task<IReadOnlyList<LookupDefinition>> GetAllAsync()
        => Task.FromResult((IReadOnlyList<LookupDefinition>)_monitor.CurrentValue);

    public Task RefreshAsync(string key) => Task.CompletedTask;
    public Task RefreshAllAsync() => Task.CompletedTask;
}
```

---

## Providers

### Providers/ILookupProvider.cs

```csharp
using Shared.LookupService.Models;

namespace Shared.LookupService.Providers;

public interface ILookupProvider
{
    Task<IEnumerable<LookupItem>> GetAsync(
        LookupDefinition def,
        IDictionary<string, object>? filters = null);
}
```

### Providers/TableLookupProvider.cs

```csharp
using Dapper;
using Shared.LookupService.Models;
using System.Data;
using System.Text;

namespace Shared.LookupService.Providers;

public class TableLookupProvider : ILookupProvider
{
    private readonly IDbConnection _db;
    public TableLookupProvider(IDbConnection db) => _db = db;

    public async Task<IEnumerable<LookupItem>> GetAsync(
        LookupDefinition def,
        IDictionary<string, object>? filters = null)
    {
        if (def.SourceType != LookupSourceType.Table)
            throw new ArgumentException("SourceType must be Table");
        if (string.IsNullOrWhiteSpace(def.TableName))
            throw new ArgumentException("TableName required");

        var codeCol = def.CodeColumn ?? "Code";
        var descCol = def.DescColumn ?? "Description";
        var select = new List<string> { $"{codeCol} AS Code", $"{descCol} AS Description" };
        select.AddRange(def.AdditionalColumns.Select(c => $"{c} AS {c}"));

        var sql = new StringBuilder($"SELECT {string.Join(", ", select)} FROM {def.TableName}");
        if (filters?.Any() == true)
        {
            var where = string.Join(" AND ",
                def.FilterColumns.Where(f => filters.ContainsKey(f))
                                 .Select(f => $"{f}=@{f}"));
            sql.Append(" WHERE ").Append(where);
        }
        if (!string.IsNullOrEmpty(def.SortBy))
            sql.Append($" ORDER BY {def.SortBy}");

        var rows = await _db.QueryAsync<dynamic>(sql.ToString(), filters);
        var list = new List<LookupItem>();
        foreach (IDictionary<string, object> row in rows)
        {
            var code = row["Code"].ToString()!;
            var desc = row["Description"].ToString()!;
            var additional = def.AdditionalColumns.ToDictionary(
                c => c,
                c => row.ContainsKey(c) ? row[c]! : null);
            list.Add(new LookupItem(code, desc, additional));
        }
        return list;
    }
}
```

### Providers/HandlerLookupProvider.cs

```csharp
using Shared.LookupService.Models;
using Shared.LookupService.Stores;

namespace Shared.LookupService.Providers;

public class HandlerLookupProvider : ILookupProvider
{
    private readonly IServiceProvider _sp;
    public HandlerLookupProvider(IServiceProvider sp) => _sp = sp;

    public async Task<IEnumerable<LookupItem>> GetAsync(
        LookupDefinition def,
        IDictionary<string, object>? filters = null)
    {
        if (def.SourceType != LookupSourceType.Handler)
            throw new ArgumentException("SourceType must be Handler");
        if (string.IsNullOrWhiteSpace(def.HandlerType))
            throw new ArgumentException("HandlerType required");

        var type = Type.GetType(def.HandlerType)
                   ?? throw new InvalidOperationException($"Cannot load {def.HandlerType}");
        var handler = (ILookupHandler)_sp.GetRequiredService(type);
        return await handler.HandleAsync(def, filters);
    }
}
```

### Providers/ProductTypeLookupHandler.cs

```csharp
using Dapper;
using Shared.LookupService.Models;
using System.Data;

namespace Shared.LookupService.Providers;

public class ProductTypeLookupHandler : ILookupHandler
{
    private readonly IDbConnection _db;
    public ProductTypeLookupHandler(IDbConnection db) => _db = db;

    public async Task<IEnumerable<LookupItem>> HandleAsync(
        LookupDefinition def,
        IDictionary<string, object>? filters = null)
    {
        if (!filters.TryGetValue("AppId", out var appId))
            throw new ArgumentException("AppId filter is required");
        var id = appId.ToString();
        if (id == "1")
        {
            var sql = "SELECT Code, Name AS Description FROM App1Products";
            return (await _db.QueryAsync<(string Code, string Description)>(sql))
                   .Select(x => new LookupItem(x.Code, x.Description));
        }
        // other logic...
        return Array.Empty<LookupItem>();
    }
}
```

---

## Factory

### Factory/LookupProviderFactory.cs

```csharp
using Shared.LookupService.Models;
using Shared.LookupService.Providers;

namespace Shared.LookupService.Factory;

public class LookupProviderFactory
{
    private readonly IEnumerable<ILookupProvider> _providers;
    public LookupProviderFactory(IEnumerable<ILookupProvider> providers)
        => _providers = providers;

    public ILookupProvider Get(LookupDefinition def)
    {
        return def.SourceType switch
        {
            LookupSourceType.Table   => _providers.OfType<TableLookupProvider>().First(),
            LookupSourceType.Sql     => _providers.OfType<TableLookupProvider>().First(),
            LookupSourceType.Entity  => _providers.OfType<TableLookupProvider>().First(),
            LookupSourceType.Handler => _providers.OfType<HandlerLookupProvider>().First(),
            _ => throw new InvalidOperationException("Unknown source type")
        };
    }
}
```

---

## Services

### Services/ILookupDataService.cs

```csharp
using Shared.LookupService.Models;

namespace Shared.LookupService.Services;

public interface ILookupDataService
{
    Task<IEnumerable<LookupItem>> GetAsync(string key, IDictionary<string, object>? filters = null);
}
```

### Services/LookupDataService.cs

```csharp
using Shared.LookupService.Models;
using Shared.LookupService.Stores;
using Shared.LookupService.Factory;

namespace Shared.LookupService.Services;

public class LookupDataService : ILookupDataService
{
    private readonly IReadOnlyDictionary<string, LookupDefinition> _defs;
    private readonly LookupProviderFactory _factory;

    public LookupDataService(ILookupDefinitionStore store, LookupProviderFactory factory)
    {
        var list = store.GetAllAsync().GetAwaiter().GetResult();
        _defs = list.ToDictionary(d => d.Key, StringComparer.OrdinalIgnoreCase);
        _factory = factory;
    }

    public Task<IEnumerable<LookupItem>> GetAsync(string key, IDictionary<string, object>? filters = null)
    {
        if (!_defs.TryGetValue(key, out var def))
            throw new KeyNotFoundException($"Lookup '{key}' not found");
        var provider = _factory.Get(def);
        return provider.GetAsync(def, filters);
    }
}
```

### Services/CachingLookupDataService.cs

```csharp
using Microsoft.Extensions.Caching.Memory;
using Shared.LookupService.Models;

namespace Shared.LookupService.Services;

public class CachingLookupDataService : ILookupDataService
{
    private readonly LookupDataService _inner;
    private readonly IMemoryCache _cache;
    private readonly TimeSpan _ttl = TimeSpan.FromMinutes(10);

    public CachingLookupDataService(LookupDataService inner, IMemoryCache cache)
    {
        _inner = inner;
        _cache = cache;
    }

    public Task<IEnumerable<LookupItem>> GetAsync(string key, IDictionary<string, object>? filters = null)
    {
        var filterKey = filters == null
            ? string.Empty
            : string.Join(";", filters.OrderBy(kv => kv.Key).Select(kv => $"{kv.Key}={kv.Value}"));
        var cacheKey = $"LookupRes:{key}:{filterKey}";
        return _cache.GetOrCreateAsync(cacheKey, entry =>
        {
            entry.SlidingExpiration = _ttl;
            return _inner.GetAsync(key, filters)!;
        })!;
    }
}
```

---

## Extensions

### Extensions/ServiceCollectionExtensions.cs

```csharp
using Shared.LookupService.Stores;
using Shared.LookupService.Providers;
using Shared.LookupService.Factory;
using Shared.LookupService.Services;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Configuration;
using Microsoft.EntityFrameworkCore;
using Shared.LookupService.Data;

namespace Shared.LookupService.Extensions;

public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddLookupDefinitions(this IServiceCollection services, IConfiguration config, string source)
    {
        services.AddMemoryCache();
        services.AddTransient<IDbConnection>(_ => new SqlConnection(config.GetConnectionString("Default")));
        services.AddSingleton<TableLookupProvider>();
        services.AddSingleton<ILookupProvider, TableLookupProvider>();
        services.AddSingleton<HandlerLookupProvider>();
        services.AddSingleton<ILookupProvider, HandlerLookupProvider>();
        services.AddSingleton<ProductTypeLookupHandler>();
        services.AddSingleton<ILookupHandler, ProductTypeLookupHandler>();
        services.AddSingleton<LookupProviderFactory>();
        services.AddSingleton<LookupDataService>();
        services.AddScoped<CachingLookupDataService>();
        services.AddScoped<ILookupDataService>(sp => sp.GetRequiredService<CachingLookupDataService>());

        if (source == "Json")
        {
            services.Configure<List<LookupDefinition>>(config.GetSection("LookupDataSettings"));
            services.AddSingleton<ILookupDefinitionStore, JsonLookupDefinitionStore>();
        }
        else if (source == "Db")
        {
            services.AddDbContext<MockDbContext>(opts => opts.UseInMemoryDatabase("LookupDb"));
            services.AddScoped<ILookupDefinitionStore, DbLookupDefinitionStore>();
        }

        return services;
    }
}
```

---

# LookupApi.Common (Mock DB-backed API)

### LookupApi.Common.csproj

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
  </PropertyGroup>
  <ItemGroup>
    <ProjectReference Include="../Shared.LookupService/Shared.LookupService.csproj" />
  </ItemGroup>
</Project>
```

### appsettings.json

```json
{
  "ConnectionStrings": { "Default": "LookupDb" },
  "Logging": { "LogLevel": { "Default": "Information" } },
  "AllowedHosts": "*"
}
```

### Program.cs

```csharp
using Shared.LookupService.Extensions;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddLookupDefinitions(builder.Configuration, "Db");
var app = builder.Build();
app.MapControllers();
app.Run();
```

### Controllers/LookupController.cs

```csharp
using Microsoft.AspNetCore.Mvc;
using Shared.LookupService.Services;

namespace LookupApi.Common.Controllers;

[ApiController]
[Route("api/[controller]")]
public class LookupController : ControllerBase
{
    private readonly ILookupDataService _lookup;
    public LookupController(ILookupDataService lookup) => _lookup = lookup;

    [HttpGet("{key}")]
    public async Task<IActionResult> Get(string key) => Ok(await _lookup.GetAsync(key));

    [HttpGet("{key}/filter")]
    public async Task<IActionResult> GetFiltered(string key, [FromQuery] Dictionary<string, object> filters)
        => Ok(await _lookup.GetAsync(key, filters));
}
```

---

# FundingModuleApi (JSON-backed API)

### FundingModuleApi.csproj

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
  </PropertyGroup>
  <ItemGroup>
    <ProjectReference Include="../Shared.LookupService/Shared.LookupService.csproj" />
  </ItemGroup>
</Project>
```

### appsettings.json

```json
{
  "LookupDataSettings": [
    {
      "Key": "Countries",
      "SourceType": "Table",
      "TableName": "RefCountries",
      "FilterColumns": ["IsActive"],
      "SortBy": "CountryName",
      "CodeColumn": "CountryCode",
      "DescColumn": "CountryName"
    }
  ],
  "Logging": { "LogLevel": { "Default": "Information" } },
  "AllowedHosts": "*"
}
```

### Program.cs

```csharp
using Shared.LookupService.Extensions;
var builder = WebApplication.CreateBuilder(args);
builder.Services.AddLookupDefinitions(builder.Configuration, "Json");
var app = builder.Build();
app.MapControllers();
app.Run();
```

### Controllers/FundingController.cs

```csharp
using Microsoft.AspNetCore.Mvc;
using Shared.LookupService.Services;

namespace FundingModuleApi.Controllers;

[ApiController]
[Route("api/[controller]")]
public class FundingController : ControllerBase
{
    private readonly ILookupDataService _lookup;
    public FundingController(ILookupDataService lookup) => _lookup = lookup;

    [HttpGet("countries")]
    public async Task<IActionResult> GetCountries()
    {
        var data = await _lookup.GetAsync("Countries");
        return Ok(data);
    }
}
```
