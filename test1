@startuml
title Funding Return Save - End to End Flow (Portrait with Safe JSON Samples)

top to bottom direction
skinparam componentStyle rectangle


'=== UI LAYER ===
package "UI" {
  [Return UI Save (user clicks Save)] as BtnSave
}

'=== API LAYER ===
package ".NET Core API" {
  [Controller (receives request)] as Ctrl
  [TransactionOrchestrator] as TxnOrch
  [ApplyChanges (update EF entities)] as Apply
  [AuditCaptureService (build AuditContext)] as AuditCap
  [HandlerChainResolver (compute handlers)] as HandlerRes
  [WorkItemFactory (build payload)] as PayloadBuild
  [WorkItemQueueWriter (insert queue row)] as QueueWrite
}

'=== BUSINESS DB ===
database "Business DB" {
  [Loan / Funding Tables] as BizTables
}

'=== QUEUE DB ===
database "Queue DB" {
  [WORK_ITEM_QUEUE] as WQ
}

'=== WORKER SERVICE ===
package "Worker Service" {
  [Poller (fetch pending items)] as Poll
  [WorkItemProcessor] as ProcItem
  [ContextBuilder (deserialize payload)] as CtxBuild
}

'=== HANDLERS ===
package "Handlers" {
  [Generic_Save_Handler] as HGen
  [FundingModule_Return_Handler] as HFundReturn
  [FundingModule_Return_Save_Handler] as HFundReturnSave
}

'=== PROCESSORS ===
package "Processors" {
  [AuditTrailProcessor] as PAudit
  [EventCreatorProcessor] as PEvent
  [StatusUpdateProcessor] as PStatus
  [ServiceCallProcessor] as PService
}

'=== EXTERNAL ===
package "External Systems" {
  [Legacy Audit Engine (C++)] as LegacyAudit
  [Event Bus / Kafka] as EventBus
  [Status System] as StatusSys
  [External REST Services] as RestSvc
}


'===================== DATA NOTES ==========================

'--- Transaction Meta JSON
note right of TxnOrch
----
{
  "module": "FUNDING",
  "screen": "RETURN",
  "operation": "SAVE",
  "entityKey": "123456789",
  "userId": "u12345",
  "channel": "WEB_UI",
  "appId": "FundingPortal",
  "correlationId": "abcd-efg-123"
}
----
end note

'--- AuditContext JSON
note right of AuditCap
----
{
  "operationType": "UPDATE",
  "changes": [
    {
      "tableName": "FUNDING_RETURN",
      "columnName": "AMOUNT",
      "oldValue": "1000",
      "newValue": "1200"
    },
    {
      "tableName": "FUNDING_RETURN",
      "columnName": "RETURN_REASON",
      "oldValue": "X",
      "newValue": "Y"
    }
  ]
}
----
end note


'--- HandlerConfig JSON
note right of HandlerRes
----
[
  {
    "handlerName": "Generic_Save_Handler",
    "moduleCode": null,
    "screenCode": null,
    "operationCode": null,
    "sequenceOrder": 10
  },
  {
    "handlerName": "FundingModule_Return_Handler",
    "moduleCode": "FUNDING",
    "screenCode": "RETURN",
    "operationCode": null,
    "sequenceOrder": 20
  },
  {
    "handlerName": "FundingModule_Return_Save_Handler",
    "moduleCode": "FUNDING",
    "screenCode": "RETURN",
    "operationCode": "SAVE",
    "sequenceOrder": 30
  }
]
Resolved handlers:
[ Generic_Save_Handler,
  FundingModule_Return_Handler,
  FundingModule_Return_Save_Handler ]
----
end note


'--- WorkItem Payload JSON
note right of QueueWrite
----
{
  "meta": { ... },
  "auditContext": { ... },
  "handlers": [
    "Generic_Save_Handler",
    "FundingModule_Return_Handler",
    "FundingModule_Return_Save_Handler"
  ],
  "flags": {
    "containsSensitiveChange": true
  }
}
----
end note


'--- Processor context JSON
note right of CtxBuild
----
{
  "workItemId": 90012,
  "payload": { ... },
  "meta": payload.meta,
  "auditContext": payload.auditContext,
  "handlers": payload.handlers
}
----
end note


'===================== FLOW ==========================

BtnSave --> Ctrl
Ctrl --> TxnOrch

TxnOrch --> Apply
Apply --> BizTables

TxnOrch --> AuditCap
AuditCap --> HandlerRes
HandlerRes --> PayloadBuild
PayloadBuild --> QueueWrite
QueueWrite --> WQ

WQ --> Poll
Poll --> ProcItem
ProcItem --> CtxBuild

CtxBuild --> HGen
CtxBuild --> HFundReturn
CtxBuild --> HFundReturnSave

HGen --> PAudit
HGen --> PEvent

HFundReturn --> PAudit
HFundReturn --> PEvent

HFundReturnSave --> PAudit
HFundReturnSave --> PEvent
HFundReturnSave --> PStatus
HFundReturnSave --> PService

PAudit --> LegacyAudit
PEvent --> EventBus
PStatus --> StatusSys
PService --> RestSvc

@enduml
